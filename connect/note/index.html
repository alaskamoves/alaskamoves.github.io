<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>onlyPeers</title>
<style>
/* --------------------------------------------------
   Theme: inherit site, then scope
   -------------------------------------------------- */
@import url("/styles/css/main.css");

:root {
  --panel-bg: rgba(255,255,255,0.03);
  --border-color: #3a3a3a;
  --btn-bg: #2f2f2f;
  --btn-text: #fff;
  --btn-border: #444;
  --btn-hover-bg: #444;
  --input-bg: rgba(255,255,255,0.04);
  --focus-outline: #888;
}

/* ---- Scope root ---- */
#dm { font-family: inherit; color: inherit; }
#dm .dm-wrap { max-width: 960px; margin: 0 auto; padding: 1rem; }
#dm .dm-section { margin-block: 1rem; }

/* Utilities */
#dm *, #dm *::before, #dm *::after { box-sizing: border-box; }
#dm .is-hidden { display: none !important; }
#dm .visually-hidden { position: absolute!important; clip: rect(1px,1px,1px,1px); padding:0!important; border:0!important; height:1px!important; width:1px!important; overflow:hidden; }

/* Panels */
#dm .panel { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; }
#dm .panel + .panel { margin-top: 1rem; }

/* Actions / buttons */
#dm .btn { font-family: inherit; font-size: 1rem; background: var(--btn-bg); color: var(--btn-text); padding: .6rem 1rem; border: 1px solid var(--btn-border); border-radius: 4px; cursor: pointer; }
#dm .btn:hover { background: var(--btn-hover-bg); }
#dm .btn:disabled { opacity: .6; cursor: not-allowed; }
#dm .btn-row { display: flex; flex-wrap: wrap; gap: .5rem; }

/* Chat area */
#dm .chat-container { display: flex; flex-direction: column; height: 420px; background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 6px; }
#dm .chat-messages { flex: 1 1 auto; overflow-y: auto; padding: .75rem; }
#dm .chat-message { margin-bottom: .5rem; line-height: 1.35; }
#dm .chat-message.you { opacity: .9; }
#dm .chat-message.me { opacity: 1; font-weight: 500; }
#dm .input-row { display: grid; grid-template-columns: minmax(0,1fr) max-content max-content; gap: .5rem; padding: .75rem; border-top: 1px solid var(--border-color); }
#dm .chat-input { font-family: inherit; font-size: 1rem; padding: .6rem .7rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: inherit; min-width: 0; }
#dm .chat-input:focus { outline: 2px solid var(--focus-outline); outline-offset: 2px; }

/* Responsive */
@media (max-width: 640px) {
  #dm .dm-wrap { padding: .75rem; }
  #dm .hex-input { font-size: 1.35rem; }
  #dm .chat-container { height: 340px; }
  #dm .hex-grid { gap: .4rem; }
  #dm .btn { padding: .5rem .8rem; }
  #dm .input-row { gap: .5rem; }
  #dm .hex-input { width: 2.2ch; }
}

@media (max-width: 480px) {
  #dm .input-row { grid-template-columns: 1fr 1fr; gap: .4rem; }
  #dm #chat-input { grid-column: 1 / -1; }
  #dm .input-row .btn { width: 100%; }
  #dm .hex-input { font-size: 1.2rem; width: 12ch; }
  #dm .dm-wrap { padding: .6rem; }
}
</style>
</head>
<body>
<main class="container">

    <h1>onlyPeers</h1>

    <h3>Notate</h3>

    <div id="dm">
    <div class="panel">
    <div class="chat-container">
    <div class="chat-messages" id="chat-log" aria-live="polite"></div>
                <input id="chat-input" class="chat-input" type="text" placeholder="Type…" />
    </div>
    <div class="chat-input">
        <button class="btn" id="attach-btn" type="button">Attach</button>
        <button class="btn" id="log-btn" type="button">Log</button>
        <button class="btn" id="send-btn" type="button">Send</button>
    </div>
            <input id="file-input" class="visually-hidden" type="file" multiple />
    </div>

    </div>

    <!-- Footer -->
    <footer class="site-footer">
      <nav class="footer-nav">
        <a href="https://alaskamoves.us/index.html">&copy; 2025 Alaska Transportation &amp; Trucking L.L.C.<br /></a>
        <a href="https://alaskamoves.us/build/index.html">build</a>
        <a href="https://alaskamoves.us/connect/index.html">connect</a>
        <a href="https://alaskamoves.us/dispatch/index.html">dispatch</a>
        <a href="https://alaskamoves.us/exchange/index.html">exchange</a>
        <a href="https://alaskamoves.us/file/index.html">file</a>
      </nav>
    </footer>
</main>
<script>
(function () {
  const chatLogEl = document.getElementById('chat-log');
  const chatInput = document.getElementById('chat-input');
  const attachBtn = document.getElementById('attach-btn');
  const sendBtn = document.getElementById('send-btn');
  const logBtn = document.getElementById('log-btn');
  const fileInput = document.getElementById('file-input');

  const state = { items: [] }; // {kind:'text'|'files', role:'you'|'me', text?, files?, ts}

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
  }

  function formatBytes(bytes){
    const units=['B','KB','MB','GB','TB'];
    let i=0, num=bytes;
    while(num >= 1024 && i < units.length - 1){ num /= 1024; i++; }
    const fixed = (num >= 10 || i === 0) ? 0 : 1;
    return `${num.toFixed(fixed)} ${units[i]}`;
  }

  function scrollToBottom(){
    chatLogEl.scrollTop = chatLogEl.scrollHeight;
  }

  function appendMessageHtml(role, html){
    const el = document.createElement('div');
    el.className = `chat-message ${role}`;
    el.innerHTML = html;
    chatLogEl.appendChild(el);
    scrollToBottom();
  }

  function addText(role, text){
    const ts = new Date().toISOString();
    state.items.push({ kind:'text', role, text, ts });
    appendMessageHtml(role, escapeHtml(text));
  }

  function addFiles(role, files){
    if(!files || !files.length) return;
    const ts = new Date().toISOString();
    const metas = [];
    const parts = [];
    files.forEach(file => {
      const url = URL.createObjectURL(file);
      metas.push({ name: file.name, type: file.type, size: file.size });
      parts.push(
        `<div><span class="hex-hint">Attachment:</span> <a href="${url}" download="${encodeURIComponent(file.name)}">${escapeHtml(file.name)}</a> (${formatBytes(file.size)})</div>`
      );
    });
    state.items.push({ kind:'files', role, files: metas, ts });
    appendMessageHtml(role, parts.join(''));
  }

  // --- Events ---
  sendBtn.addEventListener('click', () => {
    const text = chatInput.value.trim();
    if(!text) return;
    addText('you', text);
    chatInput.value = '';
    chatInput.focus();
  });

  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  attachBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    const files = Array.from(fileInput.files || []);
    if (files.length) addFiles('you', files);
    // clear so selecting the same file again still triggers change
    fileInput.value = '';
  });

  logBtn.addEventListener('click', () => {
    const now = new Date();
    const header = `onlyPeers log — ${now.toLocaleString()}`;
    const lines = [header, ''];
    state.items.forEach(item => {
      const when = new Date(item.ts).toLocaleString();
      if (item.kind === 'text') {
        lines.push(`[${when}] ${item.role}: ${item.text}`);
      } else if (item.kind === 'files') {
        item.files.forEach(f => {
          lines.push(`[${when}] ${item.role} attached: ${f.name} (${formatBytes(f.size)})`);
        });
      }
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    const stamp = now.toISOString().replace(/[:.]/g,'-');
    a.download = `onlyPeers-log-${stamp}.txt`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 0);
  });
})();
</script>
</body>
</html>
